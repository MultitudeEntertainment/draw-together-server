<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Draw Together</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; font-family: system-ui, sans-serif; }
    canvas { display: block; background: #ffffff; cursor: crosshair; }

    /* PANEL GAUCHE */
    #panel {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 320px; z-index: 10; font-size: 14px;
    }
    #panel h2 { margin: 0 0 6px; font-size: 16px; }
    #panel label { display: block; margin-top: 6px; }
    #panel input[type="text"] { width: 100%; padding: 4px 6px; box-sizing: border-box; }
    #panel button { margin-top: 6px; padding: 4px 8px; font-size: 13px; cursor: pointer; }

    #rooms-list {
      max-height: 120px; overflow-y: auto; margin-top: 6px;
      border: 1px solid #ddd; border-radius: 6px; padding: 4px;
      background: #f9fafb;
    }
    .room-item {
      padding: 4px; border-radius: 4px; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
    }
    .room-item:hover { background: #e5e7eb; }

    #tools {
      margin-top: 8px; display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
    }
    #tools button { padding: 4px 8px; }

    /* PANEL AMIS DROITE */
    #friends-panel {
      position: absolute; top: 10px; right: 10px;
      width: 220px;
      background: rgba(255,255,255,0.95);
      padding: 10px; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10; font-size: 14px;
    }
    #friends-panel h3 { margin: 0 0 6px; font-size: 15px; }
    #friends-list {
      max-height: 260px; overflow-y: auto;
      margin-top: 6px; border: 1px solid #ddd;
      border-radius: 6px; padding: 4px; background: #f9fafb;
    }
    .friend-item {
      padding: 4px; border-radius: 4px; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px;
    }
    .friend-item:hover { background: #e5e7eb; }

    /* CHAT SALON */
    #chat-toggle {
      position: absolute; bottom: 20px; right: 20px;
      background: #111827; color: white;
      padding: 12px; border-radius: 50%;
      cursor: pointer; z-index: 10;
    }
    #chat-window {
      position: absolute; bottom: 80px; right: 20px;
      width: 260px; height: 300px;
      background: white; border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      display: none; flex-direction: column; overflow: hidden; z-index: 10;
    }
    #chat-header {
      background: #111827; color: white;
      padding: 8px; text-align: center; font-weight: bold; font-size: 14px;
    }
    #chat-messages { flex: 1; padding: 8px; overflow-y: auto; font-size: 13px; }
    #chat-input-area { display: flex; border-top: 1px solid #ccc; }
    #chat-input { flex: 1; padding: 6px; border: none; outline: none; font-size: 13px; }
    #chat-send { padding: 6px 10px; background: #111827; color: white; border: none; cursor: pointer; font-size: 13px; }

    /* DM PRIV√âS (align√©s horizontalement) */
    .dm-window {
      position: absolute;
      bottom: 80px;
      width: 260px; height: 260px;
      background: white; border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      display: flex; flex-direction: column; overflow: hidden; z-index: 11;
    }
    .dm-header {
      background: #1f2937; color: white;
      padding: 6px; font-size: 13px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .dm-messages { flex: 1; padding: 6px; overflow-y: auto; font-size: 13px; }
    .dm-input-area { display: flex; border-top: 1px solid #ccc; }
    .dm-input { flex: 1; padding: 6px; border: none; outline: none; font-size: 13px; }
    .dm-send { padding: 6px 10px; background: #1f2937; color: white; border: none; cursor: pointer; font-size: 13px; }

    /* NOTIFS */
    #notif {
      position: absolute; top: 10px; left: 50%;
      transform: translateX(-50%);
      background: #111827; color: white;
      padding: 8px 12px; border-radius: 8px;
      font-size: 13px; display: none; z-index: 20;
    }

    /* POPUP */
    #popup {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white; border-radius: 10px;
      padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: none; z-index: 30; max-width: 280px; font-size: 14px;
    }
    #popup button { margin-top: 8px; margin-right: 6px; }
  </style>
</head>
<body>

<canvas id="canvas"></canvas>

<!-- PANEL GAUCHE -->
<div id="panel">
  <h2>Draw Together</h2>

  <label>Pseudo :
    <input id="pseudo" type="text" value="Guest" />
  </label>

  <label>Nom du salon :
    <input id="room-name" type="text" placeholder="ex: SketchRoom" />
  </label>

  <label>
    <input id="room-public" type="checkbox" checked />
    Salon public
  </label>

  <button id="create-room">Cr√©er / devenir chef</button>
  <button id="refresh-rooms">Voir les salons</button>

  <div id="rooms-list"></div>

  <div id="tools">
    <label>Couleur : <input type="color" id="color" value="#111827" /></label>
    <label>Taille : <input type="range" id="size" min="1" max="40" value="6" /></label>
    <button id="brush-btn">Pinceau</button>
    <button id="eraser-btn">Gomme</button>
  </div>

  <label>Inviter par pseudo :
    <input id="invite-pseudo" type="text" placeholder="Pseudo" />
  </label>
  <button id="invite-btn">Inviter</button>

  <div style="margin-top:6px;font-size:12px;color:#4b5563;">
    Lien d‚Äôinvitation : <span id="invite-link" style="word-break:break-all;"></span>
  </div>
</div>

<!-- PANEL AMIS -->
<div id="friends-panel">
  <h3>Amis</h3>
  <label>Ajouter un ami :
    <input id="friend-name" type="text" placeholder="Pseudo" />
  </label>
  <button id="add-friend-btn">Ajouter</button>
  <div id="friends-list"></div>
</div>

<!-- CHAT SALON -->
<div id="chat-toggle">üí¨</div>

<div id="chat-window">
  <div id="chat-header">Chat du salon</div>
  <div id="chat-messages"></div>
  <div id="chat-input-area">
    <input id="chat-input" type="text" placeholder="Message..." />
    <button id="chat-send">Envoyer</button>
  </div>
</div>

<!-- NOTIFS -->
<div id="notif"></div>

<!-- POPUP -->
<div id="popup">
  <div id="popup-text"></div>
  <div id="popup-buttons"></div>
</div>

<script>
/* ================== CANVAS + DESSIN ================== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

let camX = -2000, camY = -2000;
let drawing = false, panning = false;
let lastX = 0, lastY = 0;
let panStartX = 0, panStartY = 0, camStartX = 0, camStartY = 0;

let pseudo = document.getElementById("pseudo").value;
let color = document.getElementById("color").value;
let size = parseInt(document.getElementById("size").value, 10);
let brushMode = "brush";

let currentRoom = null;
let currentOwner = null;
let currentPublic = true;

/* ================== NOTIFS + POPUP ================== */
const notif = document.getElementById("notif");
function showNotif(text, ms = 2500) {
  notif.textContent = text;
  notif.style.display = "block";
  setTimeout(() => { notif.style.display = "none"; }, ms);
}

const popup = document.getElementById("popup");
const popupText = document.getElementById("popup-text");
const popupButtons = document.getElementById("popup-buttons");
function showPopup(text, buttons) {
  popupText.textContent = text;
  popupButtons.innerHTML = "";
  buttons.forEach(b => {
    const btn = document.createElement("button");
    btn.textContent = b.label;
    btn.onclick = () => { popup.style.display = "none"; b.onClick(); };
    popupButtons.appendChild(btn);
  });
  popup.style.display = "block";
}

/* ================== WEBSOCKET ================== */
const ws = new WebSocket("wss://draw-together-server--johnreckels.replit.app");

ws.onopen = () => {
  ws.send(JSON.stringify({ type: "setPseudo", pseudo }));

  const params = new URLSearchParams(window.location.search);
  const roomFromLink = params.get("room");
  if (roomFromLink) {
    document.getElementById("room-name").value = roomFromLink;
    ws.send(JSON.stringify({ type: "joinRoom", room: roomFromLink }));
  } else {
    ws.send(JSON.stringify({ type: "listRooms" }));
  }
};

const friends = new Set();
const dmWindows = new Map(); // pseudo -> {root, messages, input}

/* ================== DM WINDOWS ================== */
function layoutDmWindows() {
  let index = 0;
  dmWindows.forEach((obj) => {
    obj.root.style.right = (20 + index * 270) + "px";
    index++;
  });
}

function createDmWindow(friend) {
  if (dmWindows.has(friend)) return dmWindows.get(friend);

  const root = document.createElement("div");
  root.className = "dm-window";

  const header = document.createElement("div");
  header.className = "dm-header";
  const title = document.createElement("span");
  title.textContent = "DM avec " + friend;
  const closeBtn = document.createElement("button");
  closeBtn.textContent = "√ó";
  closeBtn.style.border = "none";
  closeBtn.style.background = "transparent";
  closeBtn.style.color = "white";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    root.remove();
    dmWindows.delete(friend);
    layoutDmWindows();
  };
  header.appendChild(title);
  header.appendChild(closeBtn);

  const messages = document.createElement("div");
  messages.className = "dm-messages";

  const inputArea = document.createElement("div");
  inputArea.className = "dm-input-area";
  const input = document.createElement("input");
  input.className = "dm-input";
  input.placeholder = "Message priv√©...";
  const sendBtn = document.createElement("button");
  sendBtn.className = "dm-send";
  sendBtn.textContent = "Envoyer";

  function sendDm() {
    const text = input.value.trim();
    if (!text) return;
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "privateChat", to: friend, message: text }));
    }
    input.value = "";
  }

  sendBtn.onclick = sendDm;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendDm();
  });

  inputArea.appendChild(input);
  inputArea.appendChild(sendBtn);

  root.appendChild(header);
  root.appendChild(messages);
  root.appendChild(inputArea);

  document.body.appendChild(root);

  const obj = { root, messages, input };
  dmWindows.set(friend, obj);
  layoutDmWindows();
  return obj;
}

function addDmMessage(friend, from, message) {
  const dm = createDmWindow(friend);
  const line = document.createElement("div");
  line.innerHTML = `<strong>${from} :</strong> ${message}`;
  dm.messages.appendChild(line);
  dm.messages.scrollTop = dm.messages.scrollHeight;
}

/* ================== AMIS UI ================== */
function addFriendToList(name) {
  if (friends.has(name)) return;
  friends.add(name);
  const list = document.getElementById("friends-list");
  const div = document.createElement("div");
  div.className = "friend-item";
  div.innerHTML = `<span>${name}</span><span style="font-size:11px;color:#6b7280;">DM</span>`;
  div.onclick = () => {
    const dm = createDmWindow(name);
    dm.root.style.display = "flex";
  };
  list.appendChild(div);
}

/* ================== MESSAGES SERVEUR ================== */
ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);

  /* SALONS */
  if (msg.type === "rooms") {
    const list = document.getElementById("rooms-list");
    list.innerHTML = "";
    msg.rooms.forEach(r => {
      const div = document.createElement("div");
      div.className = "room-item";
      div.innerHTML = `
        <span>${r.name} (${r.count}) ${r.public ? "üåç" : "üîí"}</span>
        <span style="font-size:11px;color:#6b7280;">chef: ${r.owner}</span>
      `;
      div.onclick = () => {
        ws.send(JSON.stringify({ type: "joinRoom", room: r.name }));
      };
      list.appendChild(div);
    });
  }

  if (msg.type === "joinedRoom") {
    currentRoom = msg.room;
    currentPublic = msg.public;
    currentOwner = msg.owner;
    showNotif(`Salon : ${currentRoom}`);
    updateInviteLink();
  }

  if (msg.type === "roomInfo") {
    if (msg.room === currentRoom) {
      currentPublic = msg.public;
      currentOwner = msg.owner;
      updateInviteLink();
    }
  }

  if (msg.type === "joinPending") {
    showNotif(`Demande envoy√©e au chef du salon ${msg.room}`);
  }

  if (msg.type === "joinDenied") {
    showNotif(`Acc√®s refus√© au salon ${msg.room}`);
  }

  if (msg.type === "joinRequest") {
    if (msg.room === currentRoom && pseudo === currentOwner) {
      showPopup(`${msg.from} veut rejoindre ${msg.room}`, [
        {
          label: "Accepter",
          onClick: () => {
            ws.send(JSON.stringify({ type: "joinResponse", room: msg.room, target: msg.from, accept: true }));
          }
        },
        {
          label: "Refuser",
          onClick: () => {
            ws.send(JSON.stringify({ type: "joinResponse", room: msg.room, target: msg.from, accept: false }));
          }
        }
      ]);
    }
  }

  /* INVITATIONS */
  if (msg.type === "invite") {
    showPopup(`${msg.from} t‚Äôinvite dans ${msg.room}`, [
      {
        label: "Rejoindre",
        onClick: () => {
          ws.send(JSON.stringify({ type: "acceptInvite", room: msg.room }));
        }
      },
      { label: "Ignorer", onClick: () => {} }
    ]);
  }

  /* CHAT SALON */
  if (msg.type === "chat") {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${msg.pseudo} :</strong> ${msg.message}`;
    const cm = document.getElementById("chat-messages");
    cm.appendChild(div);
    cm.scrollTop = cm.scrollHeight;
  }

  /* DESSIN */
  if (msg.type === "draw") {
    drawLine(msg.x1, msg.y1, msg.x2, msg.y2, msg.color, msg.size);
  }

  /* AMIS */
  if (msg.type === "friendRequest") {
    showPopup(`${msg.from} veut t‚Äôajouter en ami`, [
      {
        label: "Accepter",
        onClick: () => {
          ws.send(JSON.stringify({ type: "friendResponse", from: msg.from, accept: true }));
        }
      },
      {
        label: "Refuser",
        onClick: () => {
          ws.send(JSON.stringify({ type: "friendResponse", from: msg.from, accept: false }));
        }
      }
    ]);
  }

  if (msg.type === "friendAdded") {
    addFriendToList(msg.friend);
    showNotif(`${msg.friend} est maintenant ton ami.`);
  }

  /* DM PRIV√âS */
  if (msg.type === "privateChat") {
    const friend = (msg.from === pseudo) ? msg.to : msg.from;
    addFriendToList(friend);
    // DM ne s‚Äôouvre pas automatiquement : on ajoute juste le message dans la fen√™tre si elle existe
    if (dmWindows.has(friend)) {
      addDmMessage(friend, msg.from, msg.message);
    } else {
      showNotif(`Nouveau message priv√© de ${friend}`);
    }
  }

  /* ERREURS / INFOS */
  if (msg.type === "error") {
    showNotif(msg.message || "Erreur");
  }
  if (msg.type === "info") {
    showNotif(msg.message || "Info");
  }
};

/* ================== INVITE LINK ================== */
function updateInviteLink() {
  const span = document.getElementById("invite-link");
  if (!currentRoom) {
    span.textContent = "";
    return;
  }
  const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(currentRoom)}`;
  span.textContent = url;
}

/* ================== DESSIN ================== */
function drawLine(x1, y1, x2, y2, c, s) {
  ctx.strokeStyle = c;
  ctx.lineWidth = s;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(x1 + camX, y1 + camY);
  ctx.lineTo(x2 + camX, y2 + camY);
  ctx.stroke();
}

canvas.addEventListener("mousedown", (e) => {
  if (e.button === 2 || e.shiftKey) {
    panning = true;
    panStartX = e.clientX;
    panStartY = e.clientY;
    camStartX = camX;
    camStartY = camY;
    return;
  }
  drawing = true;
  const w = { x: e.clientX - camX, y: e.clientY - camY };
  lastX = w.x;
  lastY = w.y;
});

canvas.addEventListener("mousemove", (e) => {
  if (panning) {
    camX = camStartX + (e.clientX - panStartX);
    camY = camStartY + (e.clientY - panStartY);
    return;
  }
  if (!drawing) return;
  const w = { x: e.clientX - camX, y: e.clientY - camY };

  const drawColor = (brushMode === "eraser") ? "#ffffff" : color;
  drawLine(lastX, lastY, w.x, w.y, drawColor, size);

  if (ws.readyState === WebSocket.OPEN && currentRoom) {
    ws.send(JSON.stringify({
      type: "draw",
      x1: lastX, y1: lastY,
      x2: w.x, y2: w.y,
      color: drawColor,
      size
    }));
  }

  lastX = w.x;
  lastY = w.y;
});

canvas.addEventListener("mouseup", () => { drawing = false; panning = false; });
canvas.addEventListener("mouseleave", () => { drawing = false; panning = false; });
canvas.addEventListener("contextmenu", (e) => e.preventDefault());

/* ================== UI ================== */
document.getElementById("color").addEventListener("input", (e) => { color = e.target.value; });
document.getElementById("size").addEventListener("input", (e) => { size = parseInt(e.target.value, 10); });
document.getElementById("pseudo").addEventListener("input", (e) => {
  pseudo = e.target.value.trim() || "Guest";
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: "setPseudo", pseudo }));
  }
});

document.getElementById("brush-btn").addEventListener("click", () => {
  brushMode = "brush";
  showNotif("Pinceau");
});
document.getElementById("eraser-btn").addEventListener("click", () => {
  brushMode = "eraser";
  showNotif("Gomme (pinceau blanc)");
});

document.getElementById("create-room").addEventListener("click", () => {
  const room = document.getElementById("room-name").value.trim();
  const isPublic = document.getElementById("room-public").checked;
  if (!room) {
    showNotif("Choisis un nom de salon.");
    return;
  }
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: "createRoom", room, public: isPublic }));
  }
});

document.getElementById("refresh-rooms").addEventListener("click", () => {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: "listRooms" }));
  }
});

document.getElementById("invite-btn").addEventListener("click", () => {
  const target = document.getElementById("invite-pseudo").value.trim();
  if (!currentRoom) {
    showNotif("Tu dois √™tre dans un salon.");
    return;
  }
  if (!target) {
    showNotif("Entre un pseudo √† inviter.");
    return;
  }
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: "invite", room: currentRoom, target }));
    showNotif(`Invitation envoy√©e √† ${target}`);
  }
});

/* AMIS */
document.getElementById("add-friend-btn").addEventListener("click", () => {
  const target = document.getElementById("friend-name").value.trim();
  if (!target) {
    showNotif("Entre un pseudo √† ajouter.");
    return;
  }
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: "addFriend", target }));
  }
});

/* CHAT SALON */
document.getElementById("chat-toggle").addEventListener("click", () => {
  const win = document.getElementById("chat-window");
  win.style.display = (win.style.display === "none" || win.style.display === "") ? "flex" : "none";
});

function sendChat() {
  const input = document.getElementById("chat-input");
  const text = input.value.trim();
  if (!text) return;
  if (!currentRoom) {
    showNotif("Rejoins un salon pour chatter.");
    return;
  }
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: "chat", message: text }));
  }
  input.value = "";
}

document.getElementById("chat-send").addEventListener("click", sendChat);
document.getElementById("chat-input").addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendChat();
});
</script>

</body>
</html>
